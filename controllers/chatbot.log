2025-05-24 21:13:35,184 - DEBUG - Calling on_part_begin with no data
2025-05-24 21:13:35,185 - DEBUG - Calling on_header_field with data[42:61]
2025-05-24 21:13:35,185 - DEBUG - Calling on_header_value with data[63:86]
2025-05-24 21:13:35,185 - DEBUG - Calling on_header_end with no data
2025-05-24 21:13:35,185 - DEBUG - Calling on_headers_finished with no data
2025-05-24 21:13:35,185 - DEBUG - Calling on_part_data with data[90:96]
2025-05-24 21:13:35,185 - DEBUG - Calling on_part_end with no data
2025-05-24 21:13:35,185 - DEBUG - Calling on_part_begin with no data
2025-05-24 21:13:35,185 - DEBUG - Calling on_header_field with data[140:159]
2025-05-24 21:13:35,185 - DEBUG - Calling on_header_value with data[161:229]
2025-05-24 21:13:35,185 - DEBUG - Calling on_header_end with no data
2025-05-24 21:13:35,185 - DEBUG - Calling on_header_field with data[231:243]
2025-05-24 21:13:35,185 - DEBUG - Calling on_header_value with data[245:254]
2025-05-24 21:13:35,185 - DEBUG - Calling on_header_end with no data
2025-05-24 21:13:35,185 - DEBUG - Calling on_headers_finished with no data
2025-05-24 21:13:35,185 - DEBUG - Calling on_part_data with data[258:32768]
2025-05-24 21:13:35,186 - DEBUG - Calling on_part_data with data[0:6689]
2025-05-24 21:13:35,186 - DEBUG - Calling on_part_end with no data
2025-05-24 21:13:35,186 - DEBUG - Calling on_end with no data
2025-05-24 21:13:35,196 - DEBUG - STREAM b'IHDR' 16 13
2025-05-24 21:13:35,196 - DEBUG - STREAM b'sBIT' 41 4
2025-05-24 21:13:35,196 - DEBUG - b'sBIT' 41 4 (unknown)
2025-05-24 21:13:35,196 - DEBUG - STREAM b'IDAT' 57 8192
2025-05-24 21:13:35,202 - ERROR - Error in get_image_information: 'Image' object has no attribute 'read'
2025-05-24 21:13:35,203 - DEBUG - Image data: []
2025-05-24 21:13:35,204 - DEBUG - Acquired connection from pool
2025-05-24 21:13:35,264 - ERROR - Error executing query: 1146 (42S02): Table 'apple_store.categories' doesn't exist
2025-05-24 21:13:35,266 - ERROR - Error getting categories: 500: Database query error: 1146 (42S02): Table 'apple_store.categories' doesn't exist
2025-05-24 21:13:35,921 - DEBUG - Request options: {'method': 'post', 'url': '/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-173e0301-9044-440e-83b9-e55ead8f94d6', 'json_data': {'messages': [{'role': 'system', 'content': '\n    Bạn là trợ lý AI phân tích câu hỏi của người dùng để tạo truy vấn SQL cho cơ sở dữ liệu về sản phẩm với bảng:\n    CREATE TABLE products (\n        id INT PRIMARY KEY AUTO_INCREMENT,\n        name VARCHAR(255) NOT NULL UNIQUE,\n        slug VARCHAR(255) NOT NULL UNIQUE,\n        description TEXT,\n        price DECIMAL(10, 2) NOT NULL DEFAULT 0.00,\n        stock INT NOT NULL DEFAULT 0,\n        image VARCHAR(255),\n        category_id INT,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL\n    );\n\n    CREATE TABLE categories (\n        id INT PRIMARY KEY AUTO_INCREMENT,\n        name VARCHAR(100) NOT NULL UNIQUE,\n        slug VARCHAR(100) NOT NULL UNIQUE,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n    );\n\n    Nhiệm vụ:\n    - Phân tích câu hỏi để xác định sản phẩm, thuộc tính (price, stock, description, all, products_consulting, image) và danh mục.\n    - Trả về JSON với các trường:\n      - `product`: Tên sản phẩm (hoặc null).\n      - `attribute`: Thuộc tính (price, stock, description, all, products_consulting, image).\n      - `sql_query`: Truy vấn SQL (sử dụng LIKE cho tên sản phẩm).\n      - `error`: Lỗi nếu có (hoặc null).\n      - `category`: Danh mục (iphone, macbook, case, airpod, watch, macstudio, macmini, ipad).\n\n    Ví dụ:\n    Câu hỏi: "Giá của iPhone là bao nhiêu?"\n    Kết quả: {\n        "product": "iphone",\n        "attribute": "price",\n        "category": "iphone",\n        "sql_query": "SELECT p.name, p.price FROM products p JOIN categories c ON p.category_id = c.id WHERE LOWER(p.name) LIKE \'%iphone%\' AND LOWER(c.name) = \'iphone\'",\n        "error": null\n    }\n\n    Câu hỏi: "Ốp iPhone 16 có xịn không?"\n    Kết quả: {\n        "product": "iphone 16",\n        "attribute": "description",\n        "category": "case",\n        "sql_query": "SELECT p.id, p.name, p.description, p.image FROM products p JOIN categories c ON p.category_id = c.id WHERE LOWER(p.name) LIKE \'%iphone 16%\' AND LOWER(c.name) = \'case\'",\n        "error": null\n    }\n\n    Câu hỏi: "Tư vấn iPhone dưới 20 triệu"\n    Kết quả: {\n        "product": "iphone",\n        "attribute": "products_consulting",\n        "category": "iphone",\n        "sql_query": "SELECT p.name, p.price, p.description, p.image FROM products p JOIN categories c ON p.category_id = c.id WHERE LOWER(p.name) LIKE \'%iphone%\' AND LOWER(c.name) = \'iphone\' AND p.price < 20000000",\n        "error": null\n    }\n\n    Câu hỏi: "So sánh ảnh iPhone 15 và iPhone 16"\n    Kết quả: {\n        "product": "iphone",\n        "attribute": "image",\n        "category": "iphone",\n        "sql_query": "SELECT p.name, p.image FROM products p JOIN categories c ON p.category_id = c.id WHERE LOWER(p.name) LIKE \'%iphone%\' AND LOWER(c.name) = \'iphone\'",\n        "error": null\n    }\n\n    Phân tích: "string"\n    '}, {'role': 'user', 'content': 'string'}], 'model': 'grok-3-mini-fast-beta', 'max_tokens': 1000, 'temperature': 0}}
2025-05-24 21:13:36,011 - DEBUG - Sending HTTP Request: POST https://api.x.ai/v1/chat/completions
2025-05-24 21:13:36,013 - DEBUG - connect_tcp.started host='api.x.ai' port=443 local_address=None timeout=5.0 socket_options=None
2025-05-24 21:13:36,130 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x7546111d3c40>
2025-05-24 21:13:36,130 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x75461a72f2c0> server_hostname='api.x.ai' timeout=5.0
2025-05-24 21:13:36,264 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x7546111d3880>
2025-05-24 21:13:36,265 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-05-24 21:13:36,266 - DEBUG - send_request_headers.complete
2025-05-24 21:13:36,266 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-05-24 21:13:36,267 - DEBUG - send_request_body.complete
2025-05-24 21:13:36,267 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-05-24 21:13:40,097 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Sat, 24 May 2025 14:13:39 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-zero-data-retention', b'false'), (b'x-request-id', b'00-29db6ef9658798d4f3d167a7bfab6e5e-25d9fa2c000a2539-01'), (b'vary', b'origin, access-control-request-method, access-control-request-headers'), (b'access-control-allow-origin', b'*'), (b'access-control-expose-headers', b'*'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=1noYuXnCK1hsZ2PHeZrceV93JqbPygXF11NBzg85GzU-1748096019-1.0.1.1-1AgTy78tnwkyL4mrHd.zGxuJPGhNJoNJUATrnF2V33WYKn1v38KRibsG3yGWJxqm4c_Vsxwt3.kaS.WCnqOcZPgqQWbjgM.pNHZnLkok7Fs; path=/; expires=Sat, 24-May-25 14:43:39 GMT; domain=.x.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=31536000'), (b'Server', b'cloudflare'), (b'CF-RAY', b'944d6505ab37ddc2-HKG'), (b'Content-Encoding', b'gzip')])
2025-05-24 21:13:40,100 - INFO - HTTP Request: POST https://api.x.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-24 21:13:40,101 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-05-24 21:13:40,101 - DEBUG - receive_response_body.complete
2025-05-24 21:13:40,102 - DEBUG - response_closed.started
2025-05-24 21:13:40,102 - DEBUG - response_closed.complete
2025-05-24 21:13:40,102 - DEBUG - HTTP Response: POST https://api.x.ai/v1/chat/completions "200 OK" Headers({'date': 'Sat, 24 May 2025 14:13:39 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'x-zero-data-retention': 'false', 'x-request-id': '00-29db6ef9658798d4f3d167a7bfab6e5e-25d9fa2c000a2539-01', 'vary': 'origin, access-control-request-method, access-control-request-headers', 'access-control-allow-origin': '*', 'access-control-expose-headers': '*', 'cf-cache-status': 'DYNAMIC', 'set-cookie': '__cf_bm=1noYuXnCK1hsZ2PHeZrceV93JqbPygXF11NBzg85GzU-1748096019-1.0.1.1-1AgTy78tnwkyL4mrHd.zGxuJPGhNJoNJUATrnF2V33WYKn1v38KRibsG3yGWJxqm4c_Vsxwt3.kaS.WCnqOcZPgqQWbjgM.pNHZnLkok7Fs; path=/; expires=Sat, 24-May-25 14:43:39 GMT; domain=.x.ai; HttpOnly; Secure; SameSite=None', 'strict-transport-security': 'max-age=31536000', 'server': 'cloudflare', 'cf-ray': '944d6505ab37ddc2-HKG', 'content-encoding': 'gzip'})
2025-05-24 21:13:40,102 - DEBUG - request_id: 00-29db6ef9658798d4f3d167a7bfab6e5e-25d9fa2c000a2539-01
2025-05-24 21:13:40,115 - DEBUG - Analyze prompt API response: {
    "product": null,
    "attribute": null,
    "category": null,
    "sql_query": null,
    "error": "Câu hỏi không hợp lệ hoặc không rõ ràng. Vui lòng cung cấp câu hỏi cụ thể về sản phẩm, thuộc tính hoặc danh mục."
}
2025-05-24 21:13:40,118 - DEBUG - Request options: {'method': 'post', 'url': '/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-1ff69c75-a57b-487c-9dd2-1dc511372606', 'json_data': {'messages': [{'role': 'system', 'content': '\n    Bạn là Octopus Kraken, trợ lý ảo thông minh của Apple Store, chuyên bán sản phẩm Apple như iPhone, MacBook, Apple Watch, AirPods, Case, v.v.\n\n    Hướng dẫn:\n    - Trả lời dựa trên dữ liệu từ cơ sở dữ liệu (results) và thông tin ảnh (image_data).\n    - Nếu không có câu hỏi (prompt=None), trả lời dựa trên sản phẩm tương đồng từ ảnh (image_data).\n    - Nếu có câu hỏi và ảnh, kết hợp cả hai để trả lời chi tiết.\n    - Phong cách: Lịch sự, thân thiện, gần gũi. Xưng "shop", gọi người dùng là "bạn".\n    - Nếu có dữ liệu, trả lời chi tiết, tự nhiên, tránh lặp từ, giọng điệu vui vẻ.\n    - Nếu không có dữ liệu hoặc lỗi, xin lỗi nhẹ nhàng và gợi ý liên hệ:\n      - Gmail: k100iltqbao@gmail.com\n      - Facebook: https://www.facebook.com/scammer2k4hehe\n      - Số điện thoại/Zalo: 0917947910\n    - Dựa trên `attribute`:\n      - `price`: Tập trung vào giá.\n      - `stock`: Tập trung vào số lượng tồn kho.\n      - `description`: Tập trung vào mô tả.\n      - `all`: Cung cấp đầy đủ thông tin (tên, giá, mô tả, danh mục, số lượng).\n      - `products_consulting`: Giới thiệu sản phẩm kèm mô tả và giá.\n      - `image`: Mô tả hoặc so sánh dựa trên ảnh.\n    '}, {'role': 'user', 'content': '\n                        Câu hỏi: "string"\n                        Không tìm thấy thông tin về sản phẩm hoặc lỗi: Câu hỏi không hợp lệ hoặc không rõ ràng. Vui lòng cung cấp câu hỏi cụ thể về sản phẩm, thuộc tính hoặc danh mục..\n                        Nếu có image_data: None,\n                        trả lời dựa trên sản phẩm tương đồng từ ảnh.\n                        Nếu không, xin lỗi và gợi ý liên hệ.\n                        '}], 'model': 'grok-3-mini-fast-beta', 'max_tokens': 500, 'temperature': 0.7}}
2025-05-24 21:13:40,120 - DEBUG - Sending HTTP Request: POST https://api.x.ai/v1/chat/completions
2025-05-24 21:13:40,120 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-05-24 21:13:40,121 - DEBUG - send_request_headers.complete
2025-05-24 21:13:40,121 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-05-24 21:13:40,121 - DEBUG - send_request_body.complete
2025-05-24 21:13:40,121 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-05-24 21:13:43,530 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Sat, 24 May 2025 14:13:43 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-zero-data-retention', b'false'), (b'x-request-id', b'00-ff35064bf74ccef44ced9aa2ca34363e-62245760000b2ee5-01'), (b'vary', b'origin, access-control-request-method, access-control-request-headers'), (b'access-control-allow-origin', b'*'), (b'access-control-expose-headers', b'*'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=31536000'), (b'Server', b'cloudflare'), (b'CF-RAY', b'944d651dca40ddc2-HKG'), (b'Content-Encoding', b'gzip')])
2025-05-24 21:13:43,531 - INFO - HTTP Request: POST https://api.x.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-24 21:13:43,531 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-05-24 21:13:43,532 - DEBUG - receive_response_body.complete
2025-05-24 21:13:43,532 - DEBUG - response_closed.started
2025-05-24 21:13:43,533 - DEBUG - response_closed.complete
2025-05-24 21:13:43,533 - DEBUG - HTTP Response: POST https://api.x.ai/v1/chat/completions "200 OK" Headers({'date': 'Sat, 24 May 2025 14:13:43 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'x-zero-data-retention': 'false', 'x-request-id': '00-ff35064bf74ccef44ced9aa2ca34363e-62245760000b2ee5-01', 'vary': 'origin, access-control-request-method, access-control-request-headers', 'access-control-allow-origin': '*', 'access-control-expose-headers': '*', 'cf-cache-status': 'DYNAMIC', 'strict-transport-security': 'max-age=31536000', 'server': 'cloudflare', 'cf-ray': '944d651dca40ddc2-HKG', 'content-encoding': 'gzip'})
2025-05-24 21:13:43,533 - DEBUG - request_id: 00-ff35064bf74ccef44ced9aa2ca34363e-62245760000b2ee5-01
2025-05-24 21:13:43,535 - DEBUG - Acquired connection from pool
2025-05-24 21:13:43,538 - ERROR - Error executing query: 1146 (42S02): Table 'apple_store.categories' doesn't exist
2025-05-24 21:13:43,541 - ERROR - Error getting categories: 500: Database query error: 1146 (42S02): Table 'apple_store.categories' doesn't exist
2025-05-24 21:13:43,543 - DEBUG - Request options: {'method': 'post', 'url': '/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-9e9f0ade-bcaf-4ec7-a44b-afe425c1c905', 'json_data': {'messages': [{'role': 'system', 'content': '\n    Bạn là trợ lý AI phân tích câu hỏi của người dùng để tạo truy vấn SQL cho cơ sở dữ liệu về sản phẩm với bảng:\n    CREATE TABLE products (\n        id INT PRIMARY KEY AUTO_INCREMENT,\n        name VARCHAR(255) NOT NULL UNIQUE,\n        slug VARCHAR(255) NOT NULL UNIQUE,\n        description TEXT,\n        price DECIMAL(10, 2) NOT NULL DEFAULT 0.00,\n        stock INT NOT NULL DEFAULT 0,\n        image VARCHAR(255),\n        category_id INT,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL\n    );\n\n    CREATE TABLE categories (\n        id INT PRIMARY KEY AUTO_INCREMENT,\n        name VARCHAR(100) NOT NULL UNIQUE,\n        slug VARCHAR(100) NOT NULL UNIQUE,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n    );\n\n    Nhiệm vụ:\n    - Phân tích câu hỏi để xác định sản phẩm, thuộc tính (price, stock, description, all, products_consulting, image) và danh mục.\n    - Trả về JSON với các trường:\n      - `product`: Tên sản phẩm (hoặc null).\n      - `attribute`: Thuộc tính (price, stock, description, all, products_consulting, image).\n      - `sql_query`: Truy vấn SQL (sử dụng LIKE cho tên sản phẩm).\n      - `error`: Lỗi nếu có (hoặc null).\n      - `category`: Danh mục (iphone, macbook, case, airpod, watch, macstudio, macmini, ipad).\n\n    Ví dụ:\n    Câu hỏi: "Giá của iPhone là bao nhiêu?"\n    Kết quả: {\n        "product": "iphone",\n        "attribute": "price",\n        "category": "iphone",\n        "sql_query": "SELECT p.name, p.price FROM products p JOIN categories c ON p.category_id = c.id WHERE LOWER(p.name) LIKE \'%iphone%\' AND LOWER(c.name) = \'iphone\'",\n        "error": null\n    }\n\n    Câu hỏi: "Ốp iPhone 16 có xịn không?"\n    Kết quả: {\n        "product": "iphone 16",\n        "attribute": "description",\n        "category": "case",\n        "sql_query": "SELECT p.id, p.name, p.description, p.image FROM products p JOIN categories c ON p.category_id = c.id WHERE LOWER(p.name) LIKE \'%iphone 16%\' AND LOWER(c.name) = \'case\'",\n        "error": null\n    }\n\n    Câu hỏi: "Tư vấn iPhone dưới 20 triệu"\n    Kết quả: {\n        "product": "iphone",\n        "attribute": "products_consulting",\n        "category": "iphone",\n        "sql_query": "SELECT p.name, p.price, p.description, p.image FROM products p JOIN categories c ON p.category_id = c.id WHERE LOWER(p.name) LIKE \'%iphone%\' AND LOWER(c.name) = \'iphone\' AND p.price < 20000000",\n        "error": null\n    }\n\n    Câu hỏi: "So sánh ảnh iPhone 15 và iPhone 16"\n    Kết quả: {\n        "product": "iphone",\n        "attribute": "image",\n        "category": "iphone",\n        "sql_query": "SELECT p.name, p.image FROM products p JOIN categories c ON p.category_id = c.id WHERE LOWER(p.name) LIKE \'%iphone%\' AND LOWER(c.name) = \'iphone\'",\n        "error": null\n    }\n\n    Phân tích: "string"\n    '}, {'role': 'user', 'content': 'string'}], 'model': 'grok-3-mini-fast-beta', 'max_tokens': 1000, 'temperature': 0}}
2025-05-24 21:13:43,544 - DEBUG - Sending HTTP Request: POST https://api.x.ai/v1/chat/completions
2025-05-24 21:13:43,545 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-05-24 21:13:43,546 - DEBUG - send_request_headers.complete
2025-05-24 21:13:43,546 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-05-24 21:13:43,546 - DEBUG - send_request_body.complete
2025-05-24 21:13:43,546 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-05-24 21:13:51,575 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Sat, 24 May 2025 14:13:47 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-zero-data-retention', b'false'), (b'x-request-id', b'00-d851a2ed690226848ba2a987bbe4605a-7db61b94000aba0f-01'), (b'vary', b'origin, access-control-request-method, access-control-request-headers'), (b'access-control-allow-origin', b'*'), (b'access-control-expose-headers', b'*'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=31536000'), (b'Server', b'cloudflare'), (b'CF-RAY', b'944d65332975ddc2-HKG'), (b'Content-Encoding', b'gzip')])
2025-05-24 21:13:51,576 - INFO - HTTP Request: POST https://api.x.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-24 21:13:51,576 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-05-24 21:13:51,577 - DEBUG - receive_response_body.complete
2025-05-24 21:13:51,577 - DEBUG - response_closed.started
2025-05-24 21:13:51,577 - DEBUG - response_closed.complete
2025-05-24 21:13:51,577 - DEBUG - HTTP Response: POST https://api.x.ai/v1/chat/completions "200 OK" Headers({'date': 'Sat, 24 May 2025 14:13:47 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'x-zero-data-retention': 'false', 'x-request-id': '00-d851a2ed690226848ba2a987bbe4605a-7db61b94000aba0f-01', 'vary': 'origin, access-control-request-method, access-control-request-headers', 'access-control-allow-origin': '*', 'access-control-expose-headers': '*', 'cf-cache-status': 'DYNAMIC', 'strict-transport-security': 'max-age=31536000', 'server': 'cloudflare', 'cf-ray': '944d65332975ddc2-HKG', 'content-encoding': 'gzip'})
2025-05-24 21:13:51,578 - DEBUG - request_id: 00-d851a2ed690226848ba2a987bbe4605a-7db61b94000aba0f-01
2025-05-24 21:13:51,578 - DEBUG - Analyze prompt API response: {
    "product": null,
    "attribute": null,
    "category": null,
    "sql_query": null,
    "error": "Câu hỏi không hợp lệ hoặc không rõ ràng. Vui lòng cung cấp câu hỏi cụ thể về sản phẩm, thuộc tính hoặc danh mục."
}
2025-05-24 21:14:14,784 - DEBUG - Calling on_part_begin with no data
2025-05-24 21:14:14,784 - DEBUG - Calling on_header_field with data[42:61]
2025-05-24 21:14:14,784 - DEBUG - Calling on_header_value with data[63:86]
2025-05-24 21:14:14,784 - DEBUG - Calling on_header_end with no data
2025-05-24 21:14:14,784 - DEBUG - Calling on_headers_finished with no data
2025-05-24 21:14:14,784 - DEBUG - Calling on_part_data with data[90:121]
2025-05-24 21:14:14,784 - DEBUG - Calling on_part_end with no data
2025-05-24 21:14:14,784 - DEBUG - Calling on_part_begin with no data
2025-05-24 21:14:14,785 - DEBUG - Calling on_header_field with data[165:184]
2025-05-24 21:14:14,785 - DEBUG - Calling on_header_value with data[186:254]
2025-05-24 21:14:14,785 - DEBUG - Calling on_header_end with no data
2025-05-24 21:14:14,785 - DEBUG - Calling on_header_field with data[256:268]
2025-05-24 21:14:14,785 - DEBUG - Calling on_header_value with data[270:279]
2025-05-24 21:14:14,785 - DEBUG - Calling on_header_end with no data
2025-05-24 21:14:14,785 - DEBUG - Calling on_headers_finished with no data
2025-05-24 21:14:14,785 - DEBUG - Calling on_part_data with data[283:39482]
2025-05-24 21:14:14,785 - DEBUG - Calling on_part_end with no data
2025-05-24 21:14:14,785 - DEBUG - Calling on_end with no data
2025-05-24 21:14:14,786 - DEBUG - STREAM b'IHDR' 16 13
2025-05-24 21:14:14,786 - DEBUG - STREAM b'sBIT' 41 4
2025-05-24 21:14:14,786 - DEBUG - b'sBIT' 41 4 (unknown)
2025-05-24 21:14:14,787 - DEBUG - STREAM b'IDAT' 57 8192
2025-05-24 21:14:14,791 - ERROR - Error in get_image_information: 'Image' object has no attribute 'read'
2025-05-24 21:14:14,791 - DEBUG - Image data: []
2025-05-24 21:14:14,792 - DEBUG - Acquired connection from pool
2025-05-24 21:14:14,795 - ERROR - Error executing query: 1146 (42S02): Table 'apple_store.categories' doesn't exist
2025-05-24 21:14:14,796 - ERROR - Error getting categories: 500: Database query error: 1146 (42S02): Table 'apple_store.categories' doesn't exist
2025-05-24 21:14:14,797 - DEBUG - Request options: {'method': 'post', 'url': '/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-a2f66ecc-6848-4943-97c4-5199567aedd3', 'json_data': {'messages': [{'role': 'system', 'content': '\n    Bạn là trợ lý AI phân tích câu hỏi của người dùng để tạo truy vấn SQL cho cơ sở dữ liệu về sản phẩm với bảng:\n    CREATE TABLE products (\n        id INT PRIMARY KEY AUTO_INCREMENT,\n        name VARCHAR(255) NOT NULL UNIQUE,\n        slug VARCHAR(255) NOT NULL UNIQUE,\n        description TEXT,\n        price DECIMAL(10, 2) NOT NULL DEFAULT 0.00,\n        stock INT NOT NULL DEFAULT 0,\n        image VARCHAR(255),\n        category_id INT,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL\n    );\n\n    CREATE TABLE categories (\n        id INT PRIMARY KEY AUTO_INCREMENT,\n        name VARCHAR(100) NOT NULL UNIQUE,\n        slug VARCHAR(100) NOT NULL UNIQUE,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n    );\n\n    Nhiệm vụ:\n    - Phân tích câu hỏi để xác định sản phẩm, thuộc tính (price, stock, description, all, products_consulting, image) và danh mục.\n    - Trả về JSON với các trường:\n      - `product`: Tên sản phẩm (hoặc null).\n      - `attribute`: Thuộc tính (price, stock, description, all, products_consulting, image).\n      - `sql_query`: Truy vấn SQL (sử dụng LIKE cho tên sản phẩm).\n      - `error`: Lỗi nếu có (hoặc null).\n      - `category`: Danh mục (iphone, macbook, case, airpod, watch, macstudio, macmini, ipad).\n\n    Ví dụ:\n    Câu hỏi: "Giá của iPhone là bao nhiêu?"\n    Kết quả: {\n        "product": "iphone",\n        "attribute": "price",\n        "category": "iphone",\n        "sql_query": "SELECT p.name, p.price FROM products p JOIN categories c ON p.category_id = c.id WHERE LOWER(p.name) LIKE \'%iphone%\' AND LOWER(c.name) = \'iphone\'",\n        "error": null\n    }\n\n    Câu hỏi: "Ốp iPhone 16 có xịn không?"\n    Kết quả: {\n        "product": "iphone 16",\n        "attribute": "description",\n        "category": "case",\n        "sql_query": "SELECT p.id, p.name, p.description, p.image FROM products p JOIN categories c ON p.category_id = c.id WHERE LOWER(p.name) LIKE \'%iphone 16%\' AND LOWER(c.name) = \'case\'",\n        "error": null\n    }\n\n    Câu hỏi: "Tư vấn iPhone dưới 20 triệu"\n    Kết quả: {\n        "product": "iphone",\n        "attribute": "products_consulting",\n        "category": "iphone",\n        "sql_query": "SELECT p.name, p.price, p.description, p.image FROM products p JOIN categories c ON p.category_id = c.id WHERE LOWER(p.name) LIKE \'%iphone%\' AND LOWER(c.name) = \'iphone\' AND p.price < 20000000",\n        "error": null\n    }\n\n    Câu hỏi: "So sánh ảnh iPhone 15 và iPhone 16"\n    Kết quả: {\n        "product": "iphone",\n        "attribute": "image",\n        "category": "iphone",\n        "sql_query": "SELECT p.name, p.image FROM products p JOIN categories c ON p.category_id = c.id WHERE LOWER(p.name) LIKE \'%iphone%\' AND LOWER(c.name) = \'iphone\'",\n        "error": null\n    }\n\n    Phân tích: "iphone 16e này giá bao nhiêu"\n    '}, {'role': 'user', 'content': 'iphone 16e này giá bao nhiêu'}], 'model': 'grok-3-mini-fast-beta', 'max_tokens': 1000, 'temperature': 0}}
2025-05-24 21:14:14,798 - DEBUG - Sending HTTP Request: POST https://api.x.ai/v1/chat/completions
2025-05-24 21:14:14,799 - DEBUG - close.started
2025-05-24 21:14:14,799 - DEBUG - close.complete
2025-05-24 21:14:14,799 - DEBUG - connect_tcp.started host='api.x.ai' port=443 local_address=None timeout=5.0 socket_options=None
2025-05-24 21:14:14,865 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x754725de7610>
2025-05-24 21:14:14,865 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x75461a72f2c0> server_hostname='api.x.ai' timeout=5.0
2025-05-24 21:14:14,932 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x754725de75b0>
2025-05-24 21:14:14,932 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-05-24 21:14:14,932 - DEBUG - send_request_headers.complete
2025-05-24 21:14:14,932 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-05-24 21:14:14,932 - DEBUG - send_request_body.complete
2025-05-24 21:14:14,932 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-05-24 21:14:18,447 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Sat, 24 May 2025 14:14:18 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-zero-data-retention', b'false'), (b'x-request-id', b'00-1cb5a2ea0ec9daeceb15d696a94df773-0ce08935000b6a94-01'), (b'vary', b'origin, access-control-request-method, access-control-request-headers'), (b'access-control-allow-origin', b'*'), (b'access-control-expose-headers', b'*'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=31536000'), (b'Server', b'cloudflare'), (b'CF-RAY', b'944d65f74c280930-HKG'), (b'Content-Encoding', b'gzip')])
2025-05-24 21:14:18,448 - INFO - HTTP Request: POST https://api.x.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-24 21:14:18,448 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-05-24 21:14:18,449 - DEBUG - receive_response_body.complete
2025-05-24 21:14:18,449 - DEBUG - response_closed.started
2025-05-24 21:14:18,449 - DEBUG - response_closed.complete
2025-05-24 21:14:18,450 - DEBUG - HTTP Response: POST https://api.x.ai/v1/chat/completions "200 OK" Headers({'date': 'Sat, 24 May 2025 14:14:18 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'x-zero-data-retention': 'false', 'x-request-id': '00-1cb5a2ea0ec9daeceb15d696a94df773-0ce08935000b6a94-01', 'vary': 'origin, access-control-request-method, access-control-request-headers', 'access-control-allow-origin': '*', 'access-control-expose-headers': '*', 'cf-cache-status': 'DYNAMIC', 'strict-transport-security': 'max-age=31536000', 'server': 'cloudflare', 'cf-ray': '944d65f74c280930-HKG', 'content-encoding': 'gzip'})
2025-05-24 21:14:18,450 - DEBUG - request_id: 00-1cb5a2ea0ec9daeceb15d696a94df773-0ce08935000b6a94-01
2025-05-24 21:14:18,451 - DEBUG - Analyze prompt API response: {
    "product": "iphone 16e",
    "attribute": "price",
    "category": "iphone",
    "sql_query": "SELECT p.name, p.price FROM products p JOIN categories c ON p.category_id = c.id WHERE LOWER(p.name) LIKE '%iphone 16e%' AND LOWER(c.name) = 'iphone'",
    "error": null
}
2025-05-24 21:14:18,452 - DEBUG - Acquired connection from pool
2025-05-24 21:14:18,456 - ERROR - Error executing query: 1146 (42S02): Table 'apple_store.categories' doesn't exist
2025-05-24 21:14:18,459 - ERROR - Database query error: 500: Database query error: 1146 (42S02): Table 'apple_store.categories' doesn't exist
2025-05-24 21:14:18,462 - DEBUG - Request options: {'method': 'post', 'url': '/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-046eae1f-ed32-4e10-ad57-4cc0e516b343', 'json_data': {'messages': [{'role': 'system', 'content': '\n    Bạn là Octopus Kraken, trợ lý ảo thông minh của Apple Store, chuyên bán sản phẩm Apple như iPhone, MacBook, Apple Watch, AirPods, Case, v.v.\n\n    Hướng dẫn:\n    - Trả lời dựa trên dữ liệu từ cơ sở dữ liệu (results) và thông tin ảnh (image_data).\n    - Nếu không có câu hỏi (prompt=None), trả lời dựa trên sản phẩm tương đồng từ ảnh (image_data).\n    - Nếu có câu hỏi và ảnh, kết hợp cả hai để trả lời chi tiết.\n    - Phong cách: Lịch sự, thân thiện, gần gũi. Xưng "shop", gọi người dùng là "bạn".\n    - Nếu có dữ liệu, trả lời chi tiết, tự nhiên, tránh lặp từ, giọng điệu vui vẻ.\n    - Nếu không có dữ liệu hoặc lỗi, xin lỗi nhẹ nhàng và gợi ý liên hệ:\n      - Gmail: k100iltqbao@gmail.com\n      - Facebook: https://www.facebook.com/scammer2k4hehe\n      - Số điện thoại/Zalo: 0917947910\n    - Dựa trên `attribute`:\n      - `price`: Tập trung vào giá.\n      - `stock`: Tập trung vào số lượng tồn kho.\n      - `description`: Tập trung vào mô tả.\n      - `all`: Cung cấp đầy đủ thông tin (tên, giá, mô tả, danh mục, số lượng).\n      - `products_consulting`: Giới thiệu sản phẩm kèm mô tả và giá.\n      - `image`: Mô tả hoặc so sánh dựa trên ảnh.\n    '}, {'role': 'user', 'content': '\n                        Câu hỏi: "iphone 16e này giá bao nhiêu"\n                        Không tìm thấy thông tin về sản phẩm hoặc lỗi: None.\n                        Nếu có image_data: None,\n                        trả lời dựa trên sản phẩm tương đồng từ ảnh.\n                        Nếu không, xin lỗi và gợi ý liên hệ.\n                        '}], 'model': 'grok-3-mini-fast-beta', 'max_tokens': 500, 'temperature': 0.7}}
2025-05-24 21:14:18,464 - DEBUG - Sending HTTP Request: POST https://api.x.ai/v1/chat/completions
2025-05-24 21:14:18,464 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-05-24 21:14:18,465 - DEBUG - send_request_headers.complete
2025-05-24 21:14:18,466 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-05-24 21:14:18,466 - DEBUG - send_request_body.complete
2025-05-24 21:14:18,466 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-05-24 21:14:21,932 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Sat, 24 May 2025 14:14:21 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-zero-data-retention', b'false'), (b'x-request-id', b'00-32c85017f2a7d3c0d69cd49341a361ea-d4c4dcf6000c8fa9-01'), (b'vary', b'origin, access-control-request-method, access-control-request-headers'), (b'access-control-allow-origin', b'*'), (b'access-control-expose-headers', b'*'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=31536000'), (b'Server', b'cloudflare'), (b'CF-RAY', b'944d660d6d300930-HKG'), (b'Content-Encoding', b'gzip')])
2025-05-24 21:14:21,933 - INFO - HTTP Request: POST https://api.x.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-24 21:14:21,934 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-05-24 21:14:21,934 - DEBUG - receive_response_body.complete
2025-05-24 21:14:21,934 - DEBUG - response_closed.started
2025-05-24 21:14:21,935 - DEBUG - response_closed.complete
2025-05-24 21:14:21,935 - DEBUG - HTTP Response: POST https://api.x.ai/v1/chat/completions "200 OK" Headers({'date': 'Sat, 24 May 2025 14:14:21 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'x-zero-data-retention': 'false', 'x-request-id': '00-32c85017f2a7d3c0d69cd49341a361ea-d4c4dcf6000c8fa9-01', 'vary': 'origin, access-control-request-method, access-control-request-headers', 'access-control-allow-origin': '*', 'access-control-expose-headers': '*', 'cf-cache-status': 'DYNAMIC', 'strict-transport-security': 'max-age=31536000', 'server': 'cloudflare', 'cf-ray': '944d660d6d300930-HKG', 'content-encoding': 'gzip'})
2025-05-24 21:14:21,935 - DEBUG - request_id: 00-32c85017f2a7d3c0d69cd49341a361ea-d4c4dcf6000c8fa9-01
2025-05-24 21:14:21,937 - DEBUG - Acquired connection from pool
2025-05-24 21:14:21,939 - ERROR - Error executing query: 1146 (42S02): Table 'apple_store.categories' doesn't exist
2025-05-24 21:14:21,941 - ERROR - Error getting categories: 500: Database query error: 1146 (42S02): Table 'apple_store.categories' doesn't exist
2025-05-24 21:14:21,943 - DEBUG - Request options: {'method': 'post', 'url': '/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-dec3db01-3d2c-4c7b-ae6d-1cc51f507084', 'json_data': {'messages': [{'role': 'system', 'content': '\n    Bạn là trợ lý AI phân tích câu hỏi của người dùng để tạo truy vấn SQL cho cơ sở dữ liệu về sản phẩm với bảng:\n    CREATE TABLE products (\n        id INT PRIMARY KEY AUTO_INCREMENT,\n        name VARCHAR(255) NOT NULL UNIQUE,\n        slug VARCHAR(255) NOT NULL UNIQUE,\n        description TEXT,\n        price DECIMAL(10, 2) NOT NULL DEFAULT 0.00,\n        stock INT NOT NULL DEFAULT 0,\n        image VARCHAR(255),\n        category_id INT,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL\n    );\n\n    CREATE TABLE categories (\n        id INT PRIMARY KEY AUTO_INCREMENT,\n        name VARCHAR(100) NOT NULL UNIQUE,\n        slug VARCHAR(100) NOT NULL UNIQUE,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n    );\n\n    Nhiệm vụ:\n    - Phân tích câu hỏi để xác định sản phẩm, thuộc tính (price, stock, description, all, products_consulting, image) và danh mục.\n    - Trả về JSON với các trường:\n      - `product`: Tên sản phẩm (hoặc null).\n      - `attribute`: Thuộc tính (price, stock, description, all, products_consulting, image).\n      - `sql_query`: Truy vấn SQL (sử dụng LIKE cho tên sản phẩm).\n      - `error`: Lỗi nếu có (hoặc null).\n      - `category`: Danh mục (iphone, macbook, case, airpod, watch, macstudio, macmini, ipad).\n\n    Ví dụ:\n    Câu hỏi: "Giá của iPhone là bao nhiêu?"\n    Kết quả: {\n        "product": "iphone",\n        "attribute": "price",\n        "category": "iphone",\n        "sql_query": "SELECT p.name, p.price FROM products p JOIN categories c ON p.category_id = c.id WHERE LOWER(p.name) LIKE \'%iphone%\' AND LOWER(c.name) = \'iphone\'",\n        "error": null\n    }\n\n    Câu hỏi: "Ốp iPhone 16 có xịn không?"\n    Kết quả: {\n        "product": "iphone 16",\n        "attribute": "description",\n        "category": "case",\n        "sql_query": "SELECT p.id, p.name, p.description, p.image FROM products p JOIN categories c ON p.category_id = c.id WHERE LOWER(p.name) LIKE \'%iphone 16%\' AND LOWER(c.name) = \'case\'",\n        "error": null\n    }\n\n    Câu hỏi: "Tư vấn iPhone dưới 20 triệu"\n    Kết quả: {\n        "product": "iphone",\n        "attribute": "products_consulting",\n        "category": "iphone",\n        "sql_query": "SELECT p.name, p.price, p.description, p.image FROM products p JOIN categories c ON p.category_id = c.id WHERE LOWER(p.name) LIKE \'%iphone%\' AND LOWER(c.name) = \'iphone\' AND p.price < 20000000",\n        "error": null\n    }\n\n    Câu hỏi: "So sánh ảnh iPhone 15 và iPhone 16"\n    Kết quả: {\n        "product": "iphone",\n        "attribute": "image",\n        "category": "iphone",\n        "sql_query": "SELECT p.name, p.image FROM products p JOIN categories c ON p.category_id = c.id WHERE LOWER(p.name) LIKE \'%iphone%\' AND LOWER(c.name) = \'iphone\'",\n        "error": null\n    }\n\n    Phân tích: "iphone 16e này giá bao nhiêu"\n    '}, {'role': 'user', 'content': 'iphone 16e này giá bao nhiêu'}], 'model': 'grok-3-mini-fast-beta', 'max_tokens': 1000, 'temperature': 0}}
2025-05-24 21:14:21,945 - DEBUG - Sending HTTP Request: POST https://api.x.ai/v1/chat/completions
2025-05-24 21:14:21,946 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-05-24 21:14:21,946 - DEBUG - send_request_headers.complete
2025-05-24 21:14:21,947 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-05-24 21:14:21,947 - DEBUG - send_request_body.complete
2025-05-24 21:14:21,947 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-05-24 21:14:26,098 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Sat, 24 May 2025 14:14:25 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-zero-data-retention', b'false'), (b'x-request-id', b'00-309d4f5e5c6d559f4884ea91ccca74f6-55ddb22e000add52-01'), (b'vary', b'origin, access-control-request-method, access-control-request-headers'), (b'access-control-allow-origin', b'*'), (b'access-control-expose-headers', b'*'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=31536000'), (b'Server', b'cloudflare'), (b'CF-RAY', b'944d662348810930-HKG'), (b'Content-Encoding', b'gzip')])
2025-05-24 21:14:26,099 - INFO - HTTP Request: POST https://api.x.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-24 21:14:26,100 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-05-24 21:14:26,101 - DEBUG - receive_response_body.complete
2025-05-24 21:14:26,101 - DEBUG - response_closed.started
2025-05-24 21:14:26,101 - DEBUG - response_closed.complete
2025-05-24 21:14:26,101 - DEBUG - HTTP Response: POST https://api.x.ai/v1/chat/completions "200 OK" Headers({'date': 'Sat, 24 May 2025 14:14:25 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'x-zero-data-retention': 'false', 'x-request-id': '00-309d4f5e5c6d559f4884ea91ccca74f6-55ddb22e000add52-01', 'vary': 'origin, access-control-request-method, access-control-request-headers', 'access-control-allow-origin': '*', 'access-control-expose-headers': '*', 'cf-cache-status': 'DYNAMIC', 'strict-transport-security': 'max-age=31536000', 'server': 'cloudflare', 'cf-ray': '944d662348810930-HKG', 'content-encoding': 'gzip'})
2025-05-24 21:14:26,101 - DEBUG - request_id: 00-309d4f5e5c6d559f4884ea91ccca74f6-55ddb22e000add52-01
2025-05-24 21:14:26,102 - DEBUG - Analyze prompt API response: {
    "product": "iphone 16e",
    "attribute": "price",
    "category": "iphone",
    "sql_query": "SELECT p.name, p.price FROM products p JOIN categories c ON p.category_id = c.id WHERE LOWER(p.name) LIKE '%iphone 16e%' AND LOWER(c.name) = 'iphone'",
    "error": null
}
